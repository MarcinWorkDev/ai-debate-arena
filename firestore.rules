rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Users collection
    match /users/{userId} {
      // Users can read their own profile
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Users can create their own profile
      allow create: if isAuthenticated() && request.auth.uid == userId;
      // Users can update their own profile (except admin fields)
      allow update: if isAuthenticated() && request.auth.uid == userId &&
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['isAdmin', 'isApproved', 'isBlocked']);
      // Admin can read/update any user
      allow read, update: if isAdmin();

      // Audit log subcollection
      match /auditLog/{logId} {
        // Users can read their own audit log
        allow read: if isAuthenticated() && request.auth.uid == userId;
        // Admin can read any audit log
        allow read: if isAdmin();
        // Only admins can create audit log entries
        allow create: if isAdmin();
      }
    }

    // Debates collection
    match /debates/{debateId} {
      // Owner can read/write their debates
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Public debates can be read by anyone
      allow read: if resource.data.isPublic == true;
      // Admin can read all debates
      allow read: if isAdmin();

      // Messages subcollection
      match /messages/{messageId} {
        // Messages from public debates can be read by anyone
        allow read: if get(/databases/$(database)/documents/debates/$(debateId)).data.isPublic == true;
        // Authenticated users can read messages from their own debates
        allow read: if isAuthenticated() && 
          get(/databases/$(database)/documents/debates/$(debateId)).data.userId == request.auth.uid;
        // Admin can read all messages
        allow read: if isAdmin();
        // Only authenticated users can create messages
        allow create: if isAuthenticated();
      }
    }

    // Avatars collection
    match /avatars/{avatarId} {
      // Anyone authenticated can read public active avatars
      allow read: if isAuthenticated() &&
        resource.data.visibility == 'public' &&
        resource.data.status == 'active';

      // Users can read their own avatars (including private and blocked)
      allow read: if isAuthenticated() &&
        resource.data.authorUid == request.auth.uid;

      // Admin can read all avatars
      allow read: if isAdmin();

      // Authenticated users can create avatars (must be private, active, owned by them)
      allow create: if isAuthenticated() &&
        request.resource.data.authorUid == request.auth.uid &&
        request.resource.data.visibility == 'private' &&
        request.resource.data.status == 'active' &&
        request.resource.data.promotionStatus == 'none';

      // Author can update their own private avatars
      allow update: if isAuthenticated() &&
        resource.data.authorUid == request.auth.uid &&
        resource.data.visibility == 'private' &&
        resource.data.status == 'active' &&
        // Cannot change authorUid or visibility to public directly
        request.resource.data.authorUid == resource.data.authorUid &&
        (request.resource.data.visibility == 'private' ||
         (request.resource.data.visibility == 'private' && request.resource.data.promotionStatus == 'pending'));

      // Author can request promotion (change promotionStatus to pending)
      allow update: if isAuthenticated() &&
        resource.data.authorUid == request.auth.uid &&
        resource.data.visibility == 'private' &&
        request.resource.data.promotionStatus == 'pending';

      // Author can request unblock
      allow update: if isAuthenticated() &&
        resource.data.authorUid == request.auth.uid &&
        resource.data.status == 'blocked' &&
        request.resource.data.unblockRequested == true;

      // Admin can update any avatar (approve, reject, block, unblock)
      allow update: if isAdmin();

      // Admin can create avatars (for migration)
      allow create: if isAdmin();

      // Author can delete their own private avatars
      allow delete: if isAuthenticated() &&
        resource.data.authorUid == request.auth.uid &&
        resource.data.visibility == 'private';

      // Changelog subcollection
      match /changelog/{logId} {
        allow read: if isAuthenticated() &&
          (get(/databases/$(database)/documents/avatars/$(avatarId)).data.authorUid == request.auth.uid ||
           get(/databases/$(database)/documents/avatars/$(avatarId)).data.visibility == 'public' ||
           isAdmin());
        // Users can write changelog for their own actions
        allow create: if isAuthenticated() &&
          request.resource.data.actorUid == request.auth.uid;
        // Admin can write any changelog
        allow write: if isAdmin();
      }

      // Suggestions subcollection
      match /suggestions/{suggestionId} {
        // Can read suggestions for avatars user can read
        allow read: if isAuthenticated() &&
          (get(/databases/$(database)/documents/avatars/$(avatarId)).data.authorUid == request.auth.uid ||
           get(/databases/$(database)/documents/avatars/$(avatarId)).data.visibility == 'public' ||
           isAdmin());

        // Authenticated users can create suggestions for public avatars
        allow create: if isAuthenticated() &&
          get(/databases/$(database)/documents/avatars/$(avatarId)).data.visibility == 'public' &&
          request.resource.data.submitterUid == request.auth.uid &&
          request.resource.data.status == 'pending';

        // Admin can update suggestions (approve/reject)
        allow update: if isAdmin();
      }
    }
  }
}
